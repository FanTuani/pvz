<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>pvz</title>
        <style>
            #container {
                width: 950px;
                overflow: hidden;
            }

            #bg {
                margin-left: -100px;
            }

            #card {
                position: absolute;
                top: 0;
                left: 0;
            }
        </style>
    </head>

    <body ondragstart="return false">
        <div id="container">
            <img id="bg" src="images/Background.jpg">
            <img id="card" onclick="drag()" src="images/Peashooter.png">
        </div>
    </body>

    <script src="sprites.js"></script>
    <script>
        let zombies = [], bullets = [], shooters = []
        let idx = 0, duration = 1000, counter = 0

        window.onload = () => { // = function() {
            setInterval(() => {
                addSprites()
                spritesStep()
                onHitting()
            }, 100 / 8)
        }

        function addSprites() {
            if (idx > 20) {
                return
            }
            counter++
            if (parseInt(counter / duration) >= idx) {
                zombies.push(createZombie(idx))
                if (idx === 3) {
                    duration = 100
                    counter = duration * idx
                }
                if (idx === 10) {
                    duration = 1000
                    counter = duration * idx
                }
                if (idx === 11) {
                    duration = 100
                    counter = duration * idx
                }
                idx++
            }
        }

        function spritesStep() {
            for (let zombie of zombies) {
                zombie.step()
            }
            for (let bullet of bullets) {
                bullet.step()
            }
        }

        function hitZombie(bullet) {
            for (let zombie of zombies) {
                if (bullet.route === zombie.route && bullet.offsetLeft - 60 > zombie.offsetLeft) {
                    zombie.blood--;
                    if (zombie.blood === 0) {
                        let head = createHead(zombie)
                        zombie.src = 'images/ZombieLostHead.gif'
                        setTimeout(() => {
                            zombie.src = 'images/ZombieDie.gif'
                            container.removeChild(head)
                        }, 1000)
                        setTimeout(() => {
                            zombies = zombies.filter(item => item !== zombie)
                            container.removeChild(zombie)
                        }, 1000)
                    } else {
                        zombie.style.opacity = 0.7
                        setTimeout(() => {
                            zombie.style.opacity = 1
                        }, 100)
                    }
                    return true
                }
            }
            return false
        }

        function onHitting() {
            for (let bullet of bullets) {
                if (hitZombie(bullet)) {
                    bullet.src = 'images/BulletHit.gif'
                    return
                }
            }
        }

        function shoot(peashooter) {
            for (let zombie of zombies) {
                if (zombie.route === peashooter.route && peashooter.offsetLeft - 60 < zombie.offsetLeft) {
                    bullets.push(createBullet(peashooter, bullets.length, bullet => {
                        bullets = bullets.filter(item => item !== bullet)
                        container.removeChild(bullet)
                    }))
                }
            }
        }

        function drag() {
            createPeashooter((peashooter) => {
                peashooter.timer = setInterval(() => {
                    shoot(peashooter)
                }, 2000)
                shoot(peashooter)
            });
        }
    </script>
</html>